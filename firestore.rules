rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isStudent() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isTrainer() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer';
    }

    // Collection Group Rules
    match /{path=**}/credit_transactions/{transactionId} {
      allow read, write: if isTrainer();
    }
    
    // User Management
    match /users/{userId} {
      // Any signed-in user can create a user document (for signup).
      allow create: if isSignedIn();

      // Users can read/update their own document.
      // Trainers can read/update their assigned students.
      // Students can read their assigned trainer's document.
      allow read, update: if isSignedIn();

      // Users can list other users (e.g., trainers listing students).
      allow list: if isSignedIn();
    }
    
    // Student Submissions
    match /submissions/{submissionId} {
      // Anyone signed-in can read submissions (simplification for now).
      allow read: if isSignedIn();

      // Students can create and update their own submissions.
      // Trainers can update any submission (for feedback).
      allow create, update: if isSignedIn();
      
      // Allow trainers and students to list submissions based on their roles.
      allow list: if isSignedIn();
      
      // Feedback & Conversation Thread
      match /feedback_thread/{messageId} {
        allow read, create: if isSignedIn();
      }
    }
    
    // Credit Transactions (Subcollection)
    match /users/{userId}/credit_transactions/{transactionId} {
      allow read, create: if isSignedIn();
    }

    // Private details (like API keys, email settings)
    match /users/{userId}/private_details/{docId} {
        allow read, write: if isOwner(userId);
    }
    
    // Tests created by trainers
    match /tests/{testId} {
      // Any signed-in user can read tests.
      allow read: if isSignedIn();
      
      // Trainers can create, update, and delete tests.
      allow create, update, delete: if isTrainer();
    }

    // Credit plans created by trainers
    match /plans/{planId} {
        // Any signed-in user can read plans.
        allow read: if isSignedIn();

        // Trainers can manage their own plans.
        allow create, update, delete: if isTrainer() && request.resource.data.trainerId == request.auth.uid;
    }
    
    // Email queue for sending emails
    match /email_queue/{emailId} {
      allow create: if isSignedIn(); 
    }
    
    // Notifications for trainers/students
    match /notifications/{notificationId} {
        allow read, create, delete, update: if isSignedIn();
        allow list: if isSignedIn();
    }
  }
}